<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FMS Bill-To POD Exception Finder</title>

<style>
  :root{
    --bg:#0a0c10;
    --card:#0f1420;
    --text:#e6edf6;
    --muted:#93a4b7;
    --accent:#7c3aed;
    --accent2:#22d3ee;
    --ok:#10b981;
    --bad:#ef4444;
    --border:#1f2a3a;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:radial-gradient(1200px 900px at 10% -10%, #121a2b 0%, transparent 60%), var(--bg);
    color:var(--text);
    font-family:Inter,system-ui,sans-serif;
    padding:28px;
  }
  .wrap{max-width:980px;margin:0 auto;}

  h1{
    margin:0;
    font-size:26px;
    font-weight:800;
  }
  .sub{
    color:var(--muted);
    margin-top:6px;
    margin-bottom:10px;
  }

  .top-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:18px;
  }
  .pill{
    border-radius:999px;
    padding:6px 12px;
    font-size:12px;
    display:inline-flex;
    align-items:center;
    gap:6px;
    background:rgba(16,185,129,.07);
    border:1px solid rgba(16,185,129,.5);
    color:var(--ok);
  }
  .pill-dot{
    width:8px;height:8px;border-radius:999px;background:var(--ok);
  }

  .card{
    background:linear-gradient(180deg,rgba(255,255,255,.02),transparent),var(--card);
    border:1px solid var(--border);
    border-radius:18px;
    padding:20px;
    margin-bottom:18px;
  }

  label{
    display:block;
    font-size:14px;
    margin-bottom:6px;
    font-weight:600;
  }

  .autocomplete-wrapper{
    position:relative;
    max-width:380px;
  }
  input{
    width:100%;
    padding:12px 14px;
    border-radius:14px;
    border:1px solid var(--border);
    background:#0b0f19;
    color:var(--text);
    font-size:15px;
    outline:none;
  }
  input:focus{
    border-color:var(--accent);
    box-shadow:0 0 0 1px rgba(124,58,237,.5);
  }

  .autocomplete-list{
    position:absolute;
    top:105%;
    left:0;
    right:0;
    background:#020617;
    border:1px solid var(--border);
    border-radius:14px;
    padding:6px 0;
    max-height:220px;
    overflow-y:auto;
    display:none;
    z-index:20;
  }
  .autocomplete-item{
    padding:8px 12px;
    cursor:pointer;
  }
  .autocomplete-item:hover{
    background:#111827;
  }
  .autocomplete-main{
    font-size:14px;
    color:var(--text);
  }
  .autocomplete-sub{
    font-size:11px;
    color:var(--muted);
  }

  .billto-meta{
    margin-top:10px;
    font-size:13px;
    color:var(--muted);
  }

  .actions-row{
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    gap:10px;
    margin-top:16px;
  }

  .btn{
    padding:10px 16px;
    border-radius:14px;
    border:none;
    cursor:pointer;
    font-weight:600;
    display:inline-flex;
    align-items:center;
    gap:8px;
    font-size:14px;
  }
  .btn-primary{
    background:linear-gradient(90deg,var(--accent),var(--accent2));
    color:#020617;
  }
  .btn-secondary{
    background:#020617;
    color:var(--muted);
    border:1px solid var(--border);
  }
  .btn:disabled{
    opacity:.45;
    cursor:not-allowed;
  }

  .run-status{
    font-size:13px;
    color:var(--muted);
  }
  .run-meta{
    margin-left:auto;
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    font-size:12px;
    color:var(--muted);
  }

  .progress-wrap{
    margin-top:14px;
  }
  .progress-track{
    width:100%;
    height:8px;
    border-radius:999px;
    background:#020617;
    overflow:hidden;
    border:1px solid var(--border);
  }
  .progress-bar{
    height:100%;
    width:0%;
    background:linear-gradient(90deg,var(--accent2),var(--accent));
    transition:width .15s linear;
  }
  .progress-label{
    margin-top:4px;
    font-size:11px;
    color:var(--muted);
  }

  pre{
    white-space:pre-wrap;
    background:#020617;
    border:1px solid var(--border);
    border-radius:14px;
    padding:14px;
    font-size:13px;
    max-height:460px;
    overflow-y:auto;
    margin-top:10px;
  }
  .results-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-size:13px;
    margin-bottom:6px;
  }
</style>
</head>

<body>
<div class="wrap">

  <div class="top-row">
    <div>
      <h1>FMS Bill-To POD Exception Finder</h1>
      <div class="sub">
        Finds FMS orders for a Bill-To where a POD file exists but the order is not delivered.
      </div>
    </div>
    <div class="pill">
      <span class="pill-dot"></span>
      Authenticated to FMS
    </div>
  </div>

  <!-- Bill-To + Controls -->
  <div class="card">
    <label>Bill-To (live search)</label>
    <div class="autocomplete-wrapper">
      <input id="billToInput" type="text" placeholder="Type at least 2 characters..." autocomplete="off"/>
      <div id="billToList" class="autocomplete-list"></div>
    </div>
    <div id="billToMeta" class="billto-meta">
      Start typing to search Bill-To customers.
    </div>

    <div class="actions-row">
      <button id="runBtn" class="btn btn-primary" onclick="runPodExceptions()" disabled>
        Find POD Exceptions
      </button>
      <button id="clearBtn" class="btn btn-secondary" onclick="clearAll()">Clear</button>
      <button id="exportBtn" class="btn btn-secondary" onclick="exportResults()" disabled>
        Export Results (.txt)
      </button>

      <div class="run-meta">
        <span id="runStatus" class="run-status">Idle.</span>
        <span id="elapsedLabel">Elapsed: 0.0s</span>
      </div>
    </div>

    <div class="progress-wrap">
      <div class="progress-track">
        <div id="progressBar" class="progress-bar"></div>
      </div>
      <div id="progressLabel" class="progress-label">0/0</div>
    </div>
  </div>

  <!-- Results -->
  <div class="card">
    <div class="results-header">
      <strong>Results</strong>
      <span style="color:var(--muted);font-size:12px;">
        Format: FMS: DO | Status | PRO (if available) | POD Files
      </span>
    </div>
    <pre id="output">No results yet.</pre>
  </div>

</div>

<script>
  // --- State ---------------------------------------------------------
  const billToInput  = document.getElementById("billToInput");
  const billToList   = document.getElementById("billToList");
  const billToMeta   = document.getElementById("billToMeta");
  const runBtn       = document.getElementById("runBtn");
  const clearBtn     = document.getElementById("clearBtn");
  const exportBtn    = document.getElementById("exportBtn");
  const runStatusEl  = document.getElementById("runStatus");
  const elapsedLabel = document.getElementById("elapsedLabel");
  const progressBar  = document.getElementById("progressBar");
  const progressLabel= document.getElementById("progressLabel");
  const output       = document.getElementById("output");

  let selectedBillTo = null;   // {code, print_name}
  let isRunning      = false;
  let timerStart     = 0;
  let timerHandle    = null;
  let lastResultsText= "";

  // --- Helpers -------------------------------------------------------
  function debounce(fn,delay){
    let t;
    return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),delay); };
  }

  document.addEventListener("click",e=>{
    if (!billToList.contains(e.target) && e.target!==billToInput){
      billToList.style.display = "none";
    }
  });

  function setRunStatus(msg){
    runStatusEl.textContent = msg;
  }
  function setProgress(done,total){
    const pct = total>0 ? (done/total)*100 : 0;
    progressBar.style.width = pct.toFixed(1)+"%";
    progressLabel.textContent = `${done}/${total}`;
  }
  function startTimer(){
    timerStart = performance.now();
    if (timerHandle) clearInterval(timerHandle);
    timerHandle = setInterval(()=>{
      const secs = (performance.now()-timerStart)/1000;
      elapsedLabel.textContent = `Elapsed: ${secs.toFixed(1)}s`;
    },200);
  }
  function stopTimer(){
    if (timerHandle){
      clearInterval(timerHandle);
      timerHandle = null;
    }
  }

  function clearAll(){
    selectedBillTo = null;
    billToInput.value = "";
    billToMeta.textContent = "Start typing to search Bill-To customers.";
    billToList.innerHTML = "";
    billToList.style.display = "none";
    output.textContent = "No results yet.";
    setRunStatus("Idle.");
    setProgress(0,0);
    elapsedLabel.textContent = "Elapsed: 0.0s";
    runBtn.disabled = true;
    exportBtn.disabled = true;
    lastResultsText = "";
  }

  // --- Bill-To live search ------------------------------------------
  const debouncedSearchBillTo = debounce(async ()=>{
    const q = billToInput.value.trim();
    billToList.style.display = "none";

    if (q.length < 2){
      billToMeta.textContent = "Type at least 2 characters.";
      return;
    }

    billToMeta.textContent = "Searching…";

    try{
      const resp = await fetch("/api/fms",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({
          action:"searchBillTo",
          payload:{ code:q }
        })
      });
      const data = await resp.json();
      const items = data?.data?.items || [];

      billToList.innerHTML = "";
      if (!items.length){
        billToMeta.textContent = "No matches found.";
        const div = document.createElement("div");
        div.className="autocomplete-item";
        div.style.color="var(--muted)";
        div.textContent="No matches found.";
        billToList.appendChild(div);
        billToList.style.display="block";
        return;
      }

      items.forEach(it=>{
        const div = document.createElement("div");
        div.className = "autocomplete-item";
        div.innerHTML = `
          <div class="autocomplete-main">${it.print_name || it.code}</div>
          <div class="autocomplete-sub">${it.code}</div>
        `;
        div.onclick = ()=>{
          selectedBillTo = {
            code: it.code,
            print_name: it.print_name || it.code
          };
          billToInput.value = `${selectedBillTo.print_name} (${selectedBillTo.code})`;
          billToMeta.textContent = `Selected: ${selectedBillTo.print_name} (${selectedBillTo.code}). Click "Find POD Exceptions".`;
          billToList.style.display = "none";
          runBtn.disabled = false;
        };
        billToList.appendChild(div);
      });

      billToList.style.display = "block";
      billToMeta.textContent = "Select a Bill-To from the list.";
    }catch(err){
      console.error(err);
      billToMeta.textContent = "Error searching Bill-To.";
    }
  },300);

  billToInput.addEventListener("input",debouncedSearchBillTo);

  // --- POD Exceptions main flow -------------------------------------
  async function runPodExceptions(){
    if (!selectedBillTo || isRunning) return;

    isRunning = true;
    runBtn.disabled = true;
    exportBtn.disabled = true;
    lastResultsText = "";
    output.textContent = "";
    setRunStatus("Querying orders from FMS…");
    setProgress(0,0);
    startTimer();

    try{
      // Build query body exactly like your HAR
      const body = {
        order_nos: [],
        tracking_nos: [],
        customer_references: [],
        bols: [],
        bill_to_accounts: [selectedBillTo.code],
        master_order_ids: [],
        status: ["10","53","19","20","22","54","26","30","40","42","51","52"],
        sub_status: [],
        shipment_types: [],
        service_levels: [],
        trips: [],
        shipper_terminals: [],
        origin_states: [],
        origin_zip_codes: [],
        request_pickup_date: [],
        pickup_appointment: [],
        current_locations: [],
        service_terminals: [],
        lhs: [],
        lh_etd_date: [],
        lh_eta_date: [],
        consignee_terminals: [],
        consignee_state: [],
        consignee_zip_codes: [],
        desired_delivery_date: [],
        delivery_appointment: [],
        delivery_date: [],
        pickup_complete_date: [],
        pu_nos: [],
        po_nos: [],
        exception: false,
        delayed: false,
        hold: false,
        business_client: "",
        record_status: "0",
        page_number: 1,
        page_size: 10000
      };

      const queryResp = await fetch("/api/fms",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({
          action:"searchOrdersRaw",
          payload:{ body }
        })
      });

      const qJson = await queryResp.json();
      const orders = qJson?.data?.items || qJson?.data?.list || [];

      const total = orders.length || 0;
      if (!total){
        setRunStatus("Done. No non-delivered orders returned for this Bill-To.");
        setProgress(0,0);
        output.textContent = `No non-delivered orders found for Bill-To ${selectedBillTo.print_name} (${selectedBillTo.code}).`;
        stopTimer();
        isRunning=false;
        return;
      }

      setRunStatus(`Checking POD files for ${total} orders…`);
      setProgress(0,total);

      const exceptions = [];
      let processed = 0;

      for (const ord of orders){
        const orderNo =
          ord.order_no ||
          ord.shipment_order_no ||
          ord.shipmentOrderNo ||
          ord.shipment_no ||
          "";

        if (!orderNo){
          processed++;
          setProgress(processed,total);
          continue;
        }

        // Call backend /files for this DO
        const filesResp = await fetch("/api/fms",{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body:JSON.stringify({
            action:"files",
            payload:{ orderNo }
          })
        });

        const filesJson = await filesResp.json();

        const data = filesJson?.data;
        const fileArr = Array.isArray(data)
          ? data
          : (Array.isArray(data?.items) ? data.items : []);

        const podFiles = fileArr.filter(f => f.file_type === "POD");
        const hasPOD  = podFiles.length > 0;

        if (hasPOD){
          const statusName =
            ord.status_name ||
            ord.status_desc ||
            ord.order_status ||
            ord.status ||
            "Unknown";

          const pro =
            ord.pro ||
            ord.tracking_no ||
            ord.tracking ||
            ord.customer_pro ||
            "N/A";

          const line = `FMS: ${orderNo} | Status: ${statusName} | PRO: ${pro} | POD Files: ${podFiles.length}`;
          exceptions.push(line);
        }

        processed++;
        if (processed % 5 === 0 || processed === total){
          setProgress(processed,total);
        }
      }

      setProgress(total,total);

      let lines = [];
      if (!exceptions.length){
        lines.push(`No POD exceptions found for Bill-To ${selectedBillTo.print_name} (${selectedBillTo.code}).`);
        lines.push("");
        lines.push(`There are ${total} orders; ${total} are not delivered, but none of them have POD files attached.`);
      }else{
        lines.push(`POD exceptions for Bill-To ${selectedBillTo.print_name} (${selectedBillTo.code}):`);
        lines.push(`Total non-delivered orders checked: ${total}`);
        lines.push(`Exceptions (POD exists + not delivered): ${exceptions.length}`);
        lines.push("------------------------------------------------------------");
        lines.push(...exceptions);
      }

      const finalText = lines.join("\n");
      output.textContent = finalText;
      lastResultsText = finalText;
      exportBtn.disabled = !exceptions.length && !finalText;
      setRunStatus(`Done. ${exceptions.length} POD exception(s) found.`);
    }catch(err){
      console.error(err);
      setRunStatus("Error during POD exception check.");
      output.textContent = "Error: " + (err.message || String(err));
    }finally{
      stopTimer();
      isRunning = false;
      if (selectedBillTo) runBtn.disabled = false;
    }
  }

  function exportResults(){
    if (!lastResultsText) return;
    const blob = new Blob([lastResultsText],{type:"text/plain"});
    const url  = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "fms_pod_exceptions.txt";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
</script>
</body>
</html>

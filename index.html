<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FMS/TMS Bill-To POD Exception Finder</title>

<style>
  :root{
    --bg:#0a0c10;
    --card:#0f1420;
    --text:#e6edf6;
    --muted:#93a4b7;
    --accent:#7c3aed;
    --accent2:#22d3ee;
    --ok:#10b981;
    --bad:#ef4444;
    --border:#1f2a3a;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:radial-gradient(1200px 900px at 10% -10%, #121a2b 0%, transparent 60%), var(--bg);
    color:var(--text);
    font-family:Inter,system-ui,sans-serif;
    padding:28px;
  }
  .wrap{max-width:980px;margin:0 auto;}

  h1{
    margin:0;
    font-size:26px;
    font-weight:800;
  }
  .sub{
    color:var(--muted);
    margin-top:6px;
    margin-bottom:10px;
  }

  .top-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:18px;
  }
  .pill{
    border-radius:999px;
    padding:6px 12px;
    font-size:12px;
    display:inline-flex;
    align-items:center;
    gap:6px;
    background:rgba(16,185,129,.07);
    border:1px solid rgba(16,185,129,.5);
    color:var(--ok);
  }
  .pill-dot{
    width:8px;height:8px;border-radius:999px;background:var(--ok);
  }

  .card{
    background:linear-gradient(180deg,rgba(255,255,255,.02),transparent),var(--card);
    border:1px solid var(--border);
    border-radius:18px;
    padding:20px;
    margin-bottom:18px;
  }

  label{
    display:block;
    font-size:14px;
    margin-bottom:6px;
    font-weight:600;
  }

  .autocomplete-wrapper{
    position:relative;
    max-width:380px;
  }
  input{
    width:100%;
    padding:12px 14px;
    border-radius:14px;
    border:1px solid var(--border);
    background:#0b0f19;
    color:var(--text);
    font-size:15px;
    outline:none;
  }
  input:focus{
    border-color:var(--accent);
    box-shadow:0 0 0 1px rgba(124,58,237,.5);
  }

  .autocomplete-list{
    position:absolute;
    top:105%;
    left:0;
    right:0;
    background:#020617;
    border:1px solid var(--border);
    border-radius:14px;
    padding:6px 0;
    max-height:220px;
    overflow-y:auto;
    display:none;
    z-index:20;
  }
  .autocomplete-item{
    padding:8px 12px;
    cursor:pointer;
  }
  .autocomplete-item:hover{
    background:#111827;
  }
  .autocomplete-main{
    font-size:14px;
    color:var(--text);
  }
  .autocomplete-sub{
    font-size:11px;
    color:var(--muted);
  }

  .billto-meta{
    margin-top:10px;
    font-size:13px;
    color:var(--muted);
  }

  .actions-row{
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    gap:10px;
    margin-top:16px;
  }

  .btn{
    padding:10px 16px;
    border-radius:14px;
    border:none;
    cursor:pointer;
    font-weight:600;
    display:inline-flex;
    align-items:center;
    gap:8px;
    font-size:14px;
  }
  .btn-primary{
    background:linear-gradient(90deg,var(--accent),var(--accent2));
    color:#020617;
  }
  .btn-secondary{
    background:#020617;
    color:var(--muted);
    border:1px solid var(--border);
  }
  .btn:disabled{
    opacity:.45;
    cursor:not-allowed;
  }

  .run-status{
    font-size:13px;
    color:var(--muted);
  }
  .run-meta{
    margin-left:auto;
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    font-size:12px;
    color:var(--muted);
  }

  .progress-wrap{
    margin-top:14px;
  }
  .progress-title{
    font-size:11px;
    color:var(--muted);
    margin-bottom:4px;
  }
  .progress-track{
    width:100%;
    height:8px;
    border-radius:999px;
    background:#020617;
    overflow:hidden;
    border:1px solid var(--border);
  }
  .progress-bar{
    height:100%;
    width:0%;
    background:linear-gradient(90deg,var(--accent2),var(--accent));
    transition:width .15s linear;
  }
  .progress-bar-tms{
    height:100%;
    width:0%;
    background:linear-gradient(90deg,#22c55e,#06b6d4);
    transition:width .15s linear;
  }
  .progress-footer{
    margin-top:4px;
    font-size:11px;
    color:var(--muted);
    display:flex;
    justify-content:space-between;
  }

  pre{
    white-space:pre-wrap;
    background:#020617;
    border:1px solid var(--border);
    border-radius:14px;
    padding:14px;
    font-size:13px;
    max-height:460px;
    overflow-y:auto;
    margin-top:10px;
    font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }
  .results-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-size:13px;
    margin-bottom:6px;
  }
</style>
</head>

<body>
<div class="wrap">

  <div class="top-row">
    <div>
      <h1>FMS/TMS Bill-To POD Exception Finder</h1>
      <div class="sub">Find POD files where order is NOT delivered (FMS vs TMS).</div>
    </div>
    <div class="pill"><span class="pill-dot"></span>Authenticated</div>
  </div>

  <div class="card">
    <label>Bill-To (live search from FMS)</label>
    <div class="autocomplete-wrapper">
      <input id="billToInput" type="text" placeholder="Type at least 2 characters..." autocomplete="off"/>
      <div id="billToList" class="autocomplete-list"></div>
    </div>

    <div id="billToMeta" class="billto-meta">Start typing to search Bill-To customers.</div>

    <div class="actions-row">
      <button id="runBtn" class="btn btn-primary" onclick="runPodExceptions()" disabled>Find POD Exceptions</button>
      <button id="clearBtn" class="btn btn-secondary" onclick="clearAll()">Clear</button>
      <button id="exportBtn" class="btn btn-secondary" onclick="exportCSV()" disabled>Export CSV</button>

      <div class="run-meta">
        <span id="runStatus" class="run-status">Idle.</span>
      </div>
    </div>

    <!-- FMS progress -->
    <div class="progress-wrap">
      <div class="progress-title">FMS Orders</div>
      <div class="progress-track">
        <div id="progressBarFms" class="progress-bar"></div>
      </div>
      <div class="progress-footer">
        <span id="progressLabelFms">0/0</span>
        <span id="elapsedLabelFms">Elapsed: 0.0s</span>
      </div>
    </div>

    <!-- TMS progress -->
    <div class="progress-wrap">
      <div class="progress-title">TMS Orders</div>
      <div class="progress-track">
        <div id="progressBarTms" class="progress-bar-tms"></div>
      </div>
      <div class="progress-footer">
        <span id="progressLabelTms">0/0</span>
        <span id="elapsedLabelTms">Elapsed: 0.0s</span>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="results-header">
      <strong>Results</strong>
      <span style="color:var(--muted);font-size:12px;">Format: FMS/TMS Exception Y/N by PRO</span>
    </div>
    <pre id="output">No results yet.</pre>
  </div>

</div>

<script>
  const billToInput   = document.getElementById("billToInput");
  const billToList    = document.getElementById("billToList");
  const billToMeta    = document.getElementById("billToMeta");
  const runBtn        = document.getElementById("runBtn");
  const exportBtn     = document.getElementById("exportBtn");
  const output        = document.getElementById("output");
  const runStatusEl   = document.getElementById("runStatus");

  const progressBarFms   = document.getElementById("progressBarFms");
  const progressLabelFms = document.getElementById("progressLabelFms");
  const elapsedLabelFms  = document.getElementById("elapsedLabelFms");

  const progressBarTms   = document.getElementById("progressBarTms");
  const progressLabelTms = document.getElementById("progressLabelTms");
  const elapsedLabelTms  = document.getElementById("elapsedLabelTms");

  let selectedBillTo = null;
  let isRunning = false;
  let lastResultsCSV = "";

  let fmsTimerStart = 0;
  let fmsTimerHandle = null;
  let tmsTimerStart = 0;
  let tmsTimerHandle = null;

  function debounce(fn,delay){
    let t;
    return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),delay); };
  }
  function setRunStatus(t){ runStatusEl.textContent=t; }

  function setProgressFms(done,total){
    const pct = total>0 ? (done/total)*100 : 0;
    progressBarFms.style.width = pct+"%";
    progressLabelFms.textContent = `${done}/${total}`;
  }
  function setProgressTms(done,total){
    const pct = total>0 ? (done/total)*100 : 0;
    progressBarTms.style.width = pct+"%";
    progressLabelTms.textContent = `${done}/${total}`;
  }

  function startFmsTimer(){
    fmsTimerStart = performance.now();
    if (fmsTimerHandle) clearInterval(fmsTimerHandle);
    fmsTimerHandle = setInterval(()=>{
      const sec = ((performance.now()-fmsTimerStart)/1000).toFixed(1);
      elapsedLabelFms.textContent = `Elapsed: ${sec}s`;
    },200);
  }
  function stopFmsTimer(){
    if (fmsTimerHandle){
      clearInterval(fmsTimerHandle);
      fmsTimerHandle=null;
    }
  }
  function startTmsTimer(){
    tmsTimerStart = performance.now();
    if (tmsTimerHandle) clearInterval(tmsTimerHandle);
    tmsTimerHandle = setInterval(()=>{
      const sec = ((performance.now()-tmsTimerStart)/1000).toFixed(1);
      elapsedLabelTms.textContent = `Elapsed: ${sec}s`;
    },200);
  }
  function stopTmsTimer(){
    if (tmsTimerHandle){
      clearInterval(tmsTimerHandle);
      tmsTimerHandle=null;
    }
  }

  function clearAll(){
    billToInput.value="";
    billToList.innerHTML="";
    billToMeta.textContent="Start typing to search Bill-To customers.";
    selectedBillTo=null;
    runBtn.disabled=true;
    exportBtn.disabled=true;
    output.textContent="No results yet.";
    setRunStatus("Idle.");
    setProgressFms(0,0);
    setProgressTms(0,0);
    elapsedLabelFms.textContent="Elapsed: 0.0s";
    elapsedLabelTms.textContent="Elapsed: 0.0s";
    lastResultsCSV = "";
    stopFmsTimer();
    stopTmsTimer();
  }

  document.addEventListener("click",e=>{
    if (!billToList.contains(e.target) && e.target!==billToInput)
      billToList.style.display="none";
  });

  const debouncedBillTo = debounce(async ()=>{
    const q = billToInput.value.trim();
    billToList.style.display="none";

    if (q.length < 2){
      billToMeta.textContent="Type at least 2 characters.";
      return;
    }

    billToMeta.textContent="Searching…";

    try{
      const resp = await fetch("/api/fms",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({
          action:"searchBillTo",
          payload:{ code:q }
        })
      });

      const data = await resp.json();
      const items = data?.data?.items || [];

      billToList.innerHTML="";
      if (!items.length){
        billToMeta.textContent="No matches found.";
        billToList.style.display="block";
        return;
      }

      items.forEach(it=>{
        const div=document.createElement("div");
        div.className="autocomplete-item";
        div.innerHTML=`
          <div class="autocomplete-main">${it.print_name || it.code}</div>
          <div class="autocomplete-sub">${it.code}</div>`;
        div.onclick=()=>{
          selectedBillTo={ code:it.code, name:it.print_name || it.code };
          billToInput.value=`${selectedBillTo.name} (${selectedBillTo.code})`;
          billToMeta.textContent=`Selected: ${selectedBillTo.name}`;
          billToList.style.display="none";
          runBtn.disabled=false;
        };
        billToList.appendChild(div);
      });

      billToList.style.display="block";
      billToMeta.textContent="Select a Bill-To.";
    }
    catch(err){
      billToMeta.textContent="Error.";
      console.error(err);
    }
  },300);

  billToInput.addEventListener("input",debouncedBillTo);

  function padRight(str, width){
    str = String(str ?? "");
    if (str.length >= width) return str;
    return str + " ".repeat(width - str.length);
  }

  async function runPodExceptions(){
    if (!selectedBillTo || isRunning) return;

    isRunning=true;
    runBtn.disabled=true;
    exportBtn.disabled=true;
    output.textContent="";
    lastResultsCSV = "";

    setRunStatus("Querying FMS orders…");
    setProgressFms(0,0);
    setProgressTms(0,0);
    elapsedLabelFms.textContent="Elapsed: 0.0s";
    elapsedLabelTms.textContent="Elapsed: 0.0s";
    stopFmsTimer();
    stopTmsTimer();
    startFmsTimer();

    try{
      // 1) FMS initial search (non-delivered by Bill-To)
      const body={
        order_nos:[],tracking_nos:[],customer_references:[],bols:[],
        bill_to_accounts:[selectedBillTo.code],
        master_order_ids:[],
        status:["10","53","19","20","22","54","26","30","40","42","51","52"],
        sub_status:[],shipment_types:[],service_levels:[],trips:[],
        shipper_terminals:[],origin_states:[],origin_zip_codes:[],
        request_pickup_date:[],pickup_appointment:[],current_locations:[],
        service_terminals:[],lhs:[],lh_etd_date:[],lh_eta_date:[],
        consignee_terminals:[],consignee_state:[],consignee_zip_codes:[],
        desired_delivery_date:[],delivery_appointment:[],
        delivery_date:[],pickup_complete_date:[],
        pu_nos:[],po_nos:[],
        exception:false,delayed:false,hold:false,
        business_client:"",
        record_status:"0",
        page_number:1,page_size:10000
      };

      const queryResp = await fetch("/api/fms",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ action:"searchOrdersRaw", payload:{ body } })
      });

      const qJson = await queryResp.json();
      const orders = qJson?.data?.items || qJson?.data?.list || [];
      const totalFmsOrders = orders.length;

      if (!totalFmsOrders){
        stopFmsTimer();
        setProgressFms(0,0);
        output.textContent="No non-delivered FMS orders found.";
        setRunStatus("Done.");
        isRunning=false;
        runBtn.disabled=false;
        return;
      }

      setProgressFms(0,totalFmsOrders);

      const fmsByPro = {};
      const fmsExtraByPro = {};
      const tmsByPro = {};
      const tmsExtraByPro = {};

      const CONCURRENCY_LIMIT = 15;
      let processed = 0;
      let currentIndex = 0;

      async function getPodInfo(orderNo){
        try{
          const resp = await fetch("/api/fms",{
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body:JSON.stringify({
              action:"files",
              payload:{ orderNo }
            })
          });
          const filesJson = await resp.json();
          const fileArr = Array.isArray(filesJson?.data)
            ? filesJson.data
            : (Array.isArray(filesJson?.data?.items) ? filesJson.data.items : []);
          const podFiles = fileArr.filter(f => f.file_type === "POD");
          return podFiles.length;
        }catch(e){
          console.error("FMS files error for", orderNo, e);
          return 0;
        }
      }

      async function fmsWorker(){
        while (true){
          if (currentIndex >= orders.length) break;
          const idx = currentIndex++;
          const ord = orders[idx];

          const orderNo =
            ord.order_no || ord.shipment_order_no || ord.shipmentOrderNo || ord.shipment_no || "";

          const pro =
            ord.tracking_no || ord.tracking || ord.customer_pro || ord.pro || "";

          const proKey = pro || "";

          let statusName =
            ord.status_name || ord.status_desc || ord.order_status || ord.status || "Unknown";

          let podCount = 0;
          let hasPod = false;

          if (orderNo){
            podCount = await getPodInfo(orderNo);
            hasPod = podCount > 0;
          }

          if (proKey){
            fmsByPro[proKey] = {
              pro: proKey,
              orderNo,
              statusName,
              podCount,
              hasPod
            };
          }

          processed++;
          if (processed % 5 === 0 || processed === totalFmsOrders){
            setProgressFms(processed,totalFmsOrders);
          }
        }
      }

      const workers = [];
      for (let i=0;i<CONCURRENCY_LIMIT;i++){
        workers.push(fmsWorker());
      }
      await Promise.all(workers);

      stopFmsTimer();

      // 2) TMS initial search (Bill-To)
      setRunStatus("Querying TMS trace by Bill-To…");
      startTmsTimer();

      const tmsResp = await fetch("/api/tms",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({
          action:"traceByBillTo",
          payload:{ billToName: selectedBillTo.name, page_num:1, page_size:10000 }
        })
      });

      const tmsJson = await tmsResp.json();
      let tmsRows = tmsJson?.rows || [];

      const totalTmsBeforeFilter = tmsRows.length;

      // Filter out Delivery Complete ONLY for initial search
      tmsRows = tmsRows.filter(r=>{
        const stage = String(r.tms_order_stage || "").trim().toLowerCase();
        return stage !== "delivery complete";
      });

      const totalTmsFiltered = tmsRows.length;
      setProgressTms(0,totalTmsFiltered);

      let tmsProcessed = 0;

      for (const row of tmsRows){
        const pro = row.tms_order_pro || row.tms_order_load_no || "";
        if (!pro) continue;

        const orderId = row.tms_order_id || row.shipment_id || "";
        const stage = row.tms_order_stage || "";
        const podFound = row.pod_image === "Y";

        tmsByPro[pro] = {
          pro,
          tmsOrderId: orderId,
          stage,
          podFound
        };

        tmsProcessed++;
        setProgressTms(tmsProcessed,totalTmsFiltered);
      }

      stopTmsTimer();

      // 3) Build exception sets from INITIAL searches only
      const fmsExceptionPros = Object.values(fmsByPro)
        .filter(r => r.hasPod)
        .map(r => r.pro);

      const tmsExceptionPros = Object.values(tmsByPro)
        .filter(r => r.podFound)
        .map(r => r.pro);

      const fmsExceptionSet = new Set(fmsExceptionPros);
      const tmsExceptionSet = new Set(tmsExceptionPros);

      const allExceptionPros = [...new Set([...fmsExceptionPros, ...tmsExceptionPros])];

      // 4) Follow-up lookups for missing PROs (data only, no new exceptions)

      // FMS exceptions without any TMS record from initial search
      const missingInTms = fmsExceptionPros.filter(p => !tmsByPro[p]);

      if (missingInTms.length){
        try{
          const resp = await fetch("/api/tms",{
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body:JSON.stringify({
              action:"lookupPros",
              payload:{ pros: missingInTms }
            })
          });
          const extraTmsJson = await resp.json();
          const extraRows = extraTmsJson?.rows || [];
          for (const row of extraRows){
            const pro = row.tms_order_pro || row.tms_order_load_no || "";
            if (!pro) continue;
            const orderId = row.tms_order_id || row.shipment_id || "";
            const stage = row.tms_order_stage || "";
            const podFound = row.pod_image === "Y";

            // data only, exception still driven by initial search
            tmsExtraByPro[pro] = {
              pro,
              tmsOrderId: orderId,
              stage,
              podFound
            };
          }
        }catch(e){
          console.error("TMS lookupPros error", e);
        }
      }

      // TMS exceptions without any FMS record from initial search
      const missingInFms = tmsExceptionPros.filter(p => !fmsByPro[p]);

      if (missingInFms.length){
        try{
          const resp = await fetch("/api/fms",{
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body:JSON.stringify({
              action:"lookupPros",
              payload:{ pros: missingInFms }
            })
          });
          const extraFmsJson = await resp.json();
          const items = extraFmsJson?.data?.items || extraFmsJson?.data?.list || [];
          for (const ord of items){
            const pro =
              ord.tracking_no || ord.tracking || ord.customer_pro || ord.pro || "";
            const proKey = pro || "";
            if (!proKey) continue;

            const orderNo =
              ord.order_no || ord.shipment_order_no || ord.shipmentOrderNo || ord.shipment_no || "";

            let statusName =
              ord.status_name || ord.status_desc || ord.order_status || ord.status || "Unknown";

            let podCount = 0;
            if (orderNo){
              podCount = await getPodInfo(orderNo);  // same POD logic as initial
            }

            fmsExtraByPro[proKey] = {
              pro: proKey,
              orderNo,
              statusName,
              podCount,
              hasPod: podCount > 0
            };
          }
        }catch(e){
          console.error("FMS lookupPros error", e);
        }
      }

      // 5) Group pros (using both initial + extra data for presence)
      const groupBoth = [];
      const groupFmsOnly = [];
      const groupTmsOnly = [];

      for (const pro of allExceptionPros){
        const hasFms = !!(fmsByPro[pro] || fmsExtraByPro[pro]);
        const hasTms = !!(tmsByPro[pro] || tmsExtraByPro[pro]);

        if (hasFms && hasTms) {
          groupBoth.push(pro);
        } else if (hasFms && !hasTms) {
          groupFmsOnly.push(pro);
        } else if (!hasFms && hasTms) {
          groupTmsOnly.push(pro);
        }
      }

      function sortProArr(arr){
        arr.sort((a,b)=>{
          const na = Number(a), nb = Number(b);
          if (!Number.isNaN(na) && !Number.isNaN(nb)) return na-nb;
          return a.localeCompare(b);
        });
      }
      sortProArr(groupBoth);
      sortProArr(groupFmsOnly);
      sortProArr(groupTmsOnly);

      const podExceptionCount = allExceptionPros.length;
      const fmsExceptionCount = fmsExceptionPros.length;
      const tmsExceptionCount = tmsExceptionPros.length;

      // width calc including extra data
      let maxProLen=0,maxFmsOrderLen=0,maxTmsOrderIdLen=0;

      for (const pro of allExceptionPros){
        if (pro.length > maxProLen) maxProLen = pro.length;
        const f=fmsByPro[pro] || fmsExtraByPro[pro];
        const t=tmsByPro[pro] || tmsExtraByPro[pro];
        if (f && f.orderNo && f.orderNo.length>maxFmsOrderLen) maxFmsOrderLen=f.orderNo.length;
        if (t && t.tmsOrderId && t.tmsOrderId.length>maxTmsOrderIdLen) maxTmsOrderIdLen=t.tmsOrderId.length;
      }

      function buildBlock(pro, where){
        const lines=[];
        const f=fmsByPro[pro] || fmsExtraByPro[pro] || null;
        const t=tmsByPro[pro] || tmsExtraByPro[pro] || null;
        const proPad = padRight(pro,maxProLen);

        const fExc = fmsExceptionSet.has(pro) ? "Y" : "N";
        const tExc = tmsExceptionSet.has(pro) ? "Y" : "N";

        if (where==="both" || where==="fmsOnly" || where==="tmsOnly"){
          // FMS line
          if (f){
            const doPad = padRight(f.orderNo || "",maxFmsOrderLen);
            const podText = `POD Files Found: ${f.podCount || 0}`;
            lines.push(
              `FMS: Exception: ${fExc} | ${proPad} -> ${doPad} | Status: ${f.statusName || "Unknown"} | ${podText}`
            );
          } else {
            lines.push(`FMS: Exception: ${fExc} | ${proPad}`);
          }

          // TMS line
          if (t){
            const idPad = padRight(t.tmsOrderId || "",maxTmsOrderIdLen);
            const stageText = t.stage || "Unknown";
            const base = `TMS: Exception: ${tExc} | ${proPad} -> ${idPad} | Stage: ${stageText}`;
            lines.push(t.podFound ? `${base} | POD Found` : `${base}`);
          } else {
            lines.push(`TMS: Exception: ${tExc} | ${proPad}`);
          }
        }

        return lines.join("\n");
      }

      const blocks=[];
      for (const pro of groupBoth){
        blocks.push(buildBlock(pro,"both"));
      }
      for (const pro of groupFmsOnly){
        blocks.push(buildBlock(pro,"fmsOnly"));
      }
      for (const pro of groupTmsOnly){
        blocks.push(buildBlock(pro,"tmsOnly"));
      }

      const headerLines=[];
      headerLines.push(`Bill-To: ${selectedBillTo.name} (${selectedBillTo.code})`);
      headerLines.push(`Total Non-Delivered Orders Checked (FMS): ${totalFmsOrders}`);
      headerLines.push(`Total Non-Delivered Orders Checked (TMS): ${totalTmsFiltered}`);
      headerLines.push(
        `POD Exceptions Found (FMS/TMS): ${podExceptionCount} | FMS: ${fmsExceptionCount} / TMS: ${tmsExceptionCount}`
      );
      headerLines.push(`------------------------------------------------------------`);

      const bodyText = blocks.length ? blocks.join("\n---\n") : "";
      const allLines = headerLines.concat(bodyText ? [bodyText] : []);
      output.textContent = allLines.join("\n");

      // CSV build (exceptions only, but includes extra data where present)
      const csv = [];
      csv.push("System,pro,orderid/num,stage/status,pod");

      function csvEscape(v){
        const s = String(v ?? "");
        if (s.includes('"') || s.includes(",") || s.includes("\n")){
          return `"${s.replace(/"/g,'""')}"`;
        }
        return s;
      }

      for (const pro of groupBoth.concat(groupFmsOnly, groupTmsOnly)){
        const f = fmsByPro[pro] || fmsExtraByPro[pro];
        const t = tmsByPro[pro] || tmsExtraByPro[pro];

        if (f){
          csv.push([
            "FMS",
            csvEscape(pro),
            csvEscape(f.orderNo || ""),
            csvEscape(f.statusName || ""),
            csvEscape(`POD Files Found: ${f.podCount || 0}`)
          ].join(","));
        }

        if (t){
          csv.push([
            "TMS",
            csvEscape(pro),
            csvEscape(t.tmsOrderId || ""),
            csvEscape(t.stage || ""),
            csvEscape(t.podFound ? "POD Found" : "")
          ].join(","));
        }
      }

      lastResultsCSV = csv.join("\n");
      exportBtn.disabled = csv.length <= 1;

      setRunStatus("Done.");
    }
    catch(err){
      console.error(err);
      setRunStatus("Error");
      output.textContent="Error: "+(err.message || String(err));
      stopFmsTimer();
      stopTmsTimer();
    }
    finally{
      isRunning=false;
      if (selectedBillTo) runBtn.disabled=false;
    }
  }

  function exportCSV(){
    if (!lastResultsCSV) return;
    const blob = new Blob([lastResultsCSV],{type:"text/csv"});
    const url = URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download="fms_tms_pod_exceptions.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
</script>
</body>
</html>

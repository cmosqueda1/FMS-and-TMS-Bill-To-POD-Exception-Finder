<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FMS / TMS POD Status Compare (Bill-To)</title>

<style>
  :root{
    --bg:#0a0c10;--card:#0f1420;--text:#e6edf6;--muted:#93a4b7;
    --accent:#7c3aed;--accent2:#22d3ee;--ok:#10b981;--bad:#ef4444;--border:#1f2a3a;
  }
  *{box-sizing:border-box}
  html,body{
    margin:0;padding:0;background:var(--bg);color:var(--text);
    font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
  }
  .wrap{max-width:980px;margin:40px auto;padding:0 16px 64px}
  h1{margin:0 0 6px;font-size:26px;font-weight:800}
  .sub{color:var(--muted);margin-bottom:18px;font-size:14px}

  .card{
    background:linear-gradient(180deg,rgba(255,255,255,.02),transparent),var(--card);
    border:1px solid var(--border);
    border-radius:18px;
    padding:18px;
    box-shadow:0 10px 30px rgba(0,0,0,.35);
    margin-bottom:20px;
    position:relative;        /* FIX */
    z-index:50;               /* FIX */
    overflow:visible;         /* FIX */
  }

  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .pill{
    display:inline-flex;align-items:center;gap:6px;
    background:#0b0f19;border:1px solid var(--border);
    padding:5px 10px;border-radius:999px;color:var(--muted);font-size:12px;
  }
  .pill-dot{width:10px;height:10px;border-radius:50%;background:#f97373}

  .btn{
    cursor:pointer;border-radius:12px;padding:10px 16px;font-size:14px;
    font-weight:700;display:inline-flex;align-items:center;gap:6px;
    border:1px solid transparent;
  }
  .btn-primary{
    background:linear-gradient(90deg,var(--accent),var(--accent2));
    color:#060913
  }
  .btn-ghost{background:transparent;border-color:var(--border);color:var(--text)}
  .btn:disabled{opacity:.5;cursor:not-allowed}

  input[type=text]{
    width:350px;background:#0b0f19;border:1px solid var(--border);
    padding:10px;border-radius:14px;font-size:14px;color:var(--text);
  }

  .autocomplete-list{
    position:absolute;
    width:350px;
    background:#020617;
    border-radius:14px;
    border:1px solid var(--border);
    box-shadow:0 10px 30px rgba(0,0,0,.5);
    max-height:200px;
    overflow:auto;
    display:none;
    z-index:99999 !important;    /* FIX */
  }
  .autocomplete-item{padding:10px;cursor:pointer}
  .autocomplete-item:hover{background:#111827}

  pre{
    white-space:pre-wrap;background:#0b0f19;border:1px solid var(--border);
    border-radius:14px;padding:12px;font-size:13px;max-height:480px;overflow:auto;
  }

  .spinner{
    width:14px;height:14px;border-radius:50%;
    border:2px solid rgba(255,255,255,.3);
    border-top-color:var(--accent);
    animation:spin .6s linear infinite
  }
  @keyframes spin{to{transform:rotate(360deg)}}

  .bar{height:12px;border-radius:999px;background:#0b0f19;border:1px solid var(--border)}
  .fill{height:100%;width:0;background:linear-gradient(90deg,var(--ok),var(--accent2))}
</style>
</head>

<body>
<div class="wrap">

  <div class="row" style="justify-content:space-between;margin-bottom:20px">
    <h1>FMS / TMS POD Status Compare (Bill-To)</h1>
    <div class="row">
      <div class="pill"><span class="pill-dot" id="fmsDot"></span><span id="fmsAuth">FMS: Not authenticated</span></div>
      <div class="pill"><span class="pill-dot" id="tmsDot"></span><span id="tmsAuth">TMS: Not authenticated</span></div>
    </div>
  </div>

  <div class="sub">
    Select a Bill-To to check:<br>
    • All linked PROs in <b>FMS</b><br>
    • All linked PROs in <b>TMS</b><br>
    • Cross-match + fill missing PROs<br>
    • Show POD status & delivery status
  </div>

  <div class="card">
    <label>Bill-To (Live Search):</label>
    <div style="position:relative">
      <input id="billToInput" type="text" placeholder="Search Bill-To...">
      <div id="billToList" class="autocomplete-list"></div>
    </div>

    <div id="billToSelected" style="color:var(--muted);margin-top:6px"></div>

    <div class="row" style="margin-top:12px">
      <button class="btn btn-primary" id="runBtn" disabled>
        <span id="runSpin" class="spinner" style="display:none"></span>
        Check FMS / TMS POD
      </button>
      <button class="btn btn-ghost" id="clearBtn">Clear</button>
      <button class="btn btn-ghost" id="exportBtn" disabled>Export (.txt)</button>
    </div>

    <div class="row" style="margin-top:12px;justify-content:space-between">
      <span id="status" style="color:var(--muted)">Idle</span>
      <span id="elapsed" style="color:var(--muted)">Elapsed: 0s</span>
    </div>

    <div class="bar" style="margin-top:6px"><div id="fill" class="fill"></div></div>
    <div style="color:var(--muted);margin-top:4px" id="count">0/0</div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;margin-bottom:6px">
      <strong>Results</strong>
      <code style="color:var(--muted)">PRO: #### | FMS | TMS</code>
    </div>
    <pre id="out">No results yet.</pre>
  </div>

</div>


<script>
/* DOM */
const $ = id => document.getElementById(id);

let FMS_TOKEN = null;
let TMS_USERID = null;
let TMS_TOKEN = null;

let selectedBillTo = null;

/* UI state updates */
function setFms(ok){
  $("fmsDot").style.background = ok ? "#10b981" : "#ef4444";
  $("fmsAuth").textContent = ok ? "FMS: Authenticated" : "FMS: Not authenticated";
}
function setTms(ok){
  $("tmsDot").style.background = ok ? "#10b981" : "#ef4444";
  $("tmsAuth").textContent = ok ? "TMS: Authenticated" : "TMS: Not authenticated";
}

/* Proxy API wrappers */
async function fmsAPI(action, payload={}) {
  const resp = await fetch("/api/fms", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ action, payload })
  });
  return resp.json();
}

async function tmsAPI(action, payload={}) {
  const resp = await fetch("/api/tms", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ action, payload })
  });
  return resp.json();
}

/* AUTOCOMPLETE */
let searchTimeout=null;

$("billToInput").addEventListener("input", ()=>{
  clearTimeout(searchTimeout);

  $("billToList").style.display="none";
  const q = $("billToInput").value.trim();
  if (q.length < 2) return;

  searchTimeout=setTimeout(async()=>{

    const login = await fmsAPI("login");
    FMS_TOKEN = login?.token || login?.data?.token;
    setFms(!!FMS_TOKEN);

    const body = {
      bill_to_accounts: [],
      page_number: 1,
      page_size: 20,
      business_client: q
    };

    const result = await fmsAPI("search", { token:FMS_TOKEN, body });
    const items = result?.data?.items || [];

    $("billToList").innerHTML = "";
    items.forEach(it=>{
      const div=document.createElement("div");
      div.className="autocomplete-item";
      div.textContent=it.print_name || it.code;

      div.onclick=()=>{
        $("billToInput").value = div.textContent;
        selectedBillTo = it;
        $("billToSelected").textContent = "Selected: " + div.textContent;
        $("billToList").style.display="none";
        $("runBtn").disabled = false;
      };

      $("billToList").appendChild(div);
    });

    $("billToList").style.display="block";

  },300);
});


/* RUN SEARCH LOGIC */
$("runBtn").addEventListener("click", async()=>{

  if (!selectedBillTo) return;

  $("runSpin").style.display="inline-block";
  $("status").textContent="Logging in to FMS/TMS...";
  $("out").textContent="";
  $("fill").style.width="0%";

  /* Step 1: Login */
  const fmsLogin = await fmsAPI("login");
  FMS_TOKEN = fmsLogin?.token || fmsLogin?.data?.token;
  setFms(!!FMS_TOKEN);

  const tmsLogin = await tmsAPI("login");
  TMS_USERID = tmsLogin?.UserID;
  TMS_TOKEN = tmsLogin?.UserToken;
  setTms(!!TMS_USERID);

  /* Step 2: FMS search by Bill-To */
  $("status").textContent = "Searching FMS for Bill-To...";

  const fmsBody = {
    bill_to_accounts: [selectedBillTo.code],
    page_number: 1,
    page_size: 10000
  };

  const fmsRes = await fmsAPI("search", { token:FMS_TOKEN, body:fmsBody });
  const fmsItems = fmsRes?.data?.items || [];
  const fmsMap = new Map();

  for (const it of fmsItems) {
    const pro = String(it.reference5 || it.tracking_no || "").trim();
    if (!pro) continue;

    const pod = await fmsAPI("files", { token:FMS_TOKEN, orderNo:it.order_no });
    const files = pod?.data?.items || [];
    const hasPod = files.some(f => String(f.file_type).toUpperCase()==="POD");

    fmsMap.set(pro, {
      status: it.order_status || "N/A",
      hasPod
    });
  }

  /* Step 3: TMS search by Bill-To */
  $("status").textContent = "Searching TMS for Bill-To...";

  const tmsForm = {
    input_filter_billto: selectedBillTo.print_name || selectedBillTo.code,
    input_filter_billto_code: selectedBillTo.code,
    input_stage_id: "-4,-3,-2,-1,0,1,2,3,4",
    input_page_num: "1",
    input_page_size: "10000",
    UserID: TMS_USERID,
    UserToken: TMS_TOKEN,
    pageName: "dashboardTmsTrace"
  };

  const tmsRes = await tmsAPI("trace", tmsForm);
  const tmsRows = tmsRes?.data || tmsRes || [];
  const tmsMap = new Map();

  tmsRows.forEach(r=>{
    const pro = String(r.tms_order_pro || r.Pro || "").trim();
    if (!pro) return;

    const hasPod = String(r.pod_image||"").toUpperCase()==="Y";
    const status = r.StatusDesc || r.Status || "N/A";

    tmsMap.set(pro,{status,hasPod});
  });

  /* Step 4: Combine all PROs */
  const allPros = [...new Set([...fmsMap.keys(), ...tmsMap.keys()])];
  const total = allPros.length;
  let processed = 0;

  const lines = [];

  for (const pro of allPros) {

    /* Ensure FMS */
    let fm = fmsMap.get(pro);
    if (!fm) {
      const res = await fmsAPI("search", {
        token:FMS_TOKEN,
        body:{ tracking_nos:[pro], page_number:1, page_size:10 }
      });
      const item = res?.data?.items?.[0];
      if (item) {
        const files = await fmsAPI("files",{token:FMS_TOKEN, orderNo:item.order_no});
        const pod = files?.data?.items || [];
        fm = {
          status:item.order_status || "N/A",
          hasPod: pod.some(f=>String(f.file_type).toUpperCase()==="POD")
        };
      } else {
        fm = {status:"No FMS record found", hasPod:false};
      }
    }

    /* Ensure TMS */
    let tm = tmsMap.get(pro);
    if (!tm) {
      const form = {
        input_filter_pro: pro,
        input_stage_id: "-4,-3,-2,-1,0,1,2,3,4",
        input_page_num:"1",
        input_page_size:"10",
        UserID: TMS_USERID,
        UserToken: TMS_TOKEN,
        pageName:"dashboardTmsTrace"
      };
      const tr = await tmsAPI("trace", form);
      const row = (tr?.data || [])[0];
      tm = row
        ? {
            status: row.StatusDesc || row.Status || "N/A",
            hasPod: String(row.pod_image||"").toUpperCase()==="Y"
          }
        : {status:"No TMS record found", hasPod:false};
    }

    lines.push(
      `PRO: ${pro} | ` +
      `FMS - ${fm.hasPod?"POD found":"No POD"} | FMS Status - ${fm.status} | ` +
      `TMS - ${tm.hasPod?"POD found":"No POD"} | TMS Status - ${tm.status}`,
      "---"
    );

    processed++;
    $("count").textContent = `${processed}/${total}`;
    $("fill").style.width = (processed/total*100)+"%";
  }

  $("out").textContent = lines.join("\n");
  $("status").textContent = "Done.";
  $("runSpin").style.display="none";
  $("exportBtn").disabled=false;
});


/* Clear */
$("clearBtn").addEventListener("click", ()=>{
  selectedBillTo=null;
  $("billToInput").value="";
  $("billToSelected").textContent="";
  $("out").textContent="No results yet.";
  $("runBtn").disabled=true;
});

/* Export */
$("exportBtn").addEventListener("click", ()=>{
  const blob=new Blob([$("out").textContent],{type:"text/plain"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="billto_pod_compare.txt";
  a.click();
});
</script>

</body>
</html>
